<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.7.2/Chart.bundle.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/uikit@3.9.3/dist/js/uikit.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/uikit@3.9.3/dist/js/uikit-icons.min.js"></script>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/uikit@3.9.3/dist/css/uikit.min.css" />

    <title>Lineログビューア</title>
</head>

<body>
    <div class="uk-container">
        <div class="uk-section" id="File_selection">
            <div class="js-upload" uk-form-custom>
                <input type="file" id="fileToLoad" multiple>
                <button class="uk-button uk-button-default" type="button" tabindex="-1">アップロード</button>
            </div>
            <button class="uk-button uk-button-primary" onclick="loadFileAsText()">読み込む</button>
        </div>

        <div class="uk-section" id="status">
            ファイルを選択してください
        </div>

        <div class="uk-section" id="search-box" style="display: none;">
            <div class="uk-margin">
                <form class="uk-search uk-search-default">
                    <a href="" class="uk-search-icon-flip" id="search-button" uk-search-icon></a>
                    <input class="uk-search-input" type="search" id="search" placeholder="Search">
                </form>
            </div>
            <!--
        <input type="search" name="検索" id="search">
        <input type="button" value="検索" id="search-button">
        -->
        </div>

        <div class="uk-section" id="result" style="display:none;">
            <p id="result_title"></p>
            <table class="uk-table uk-table-divider" id="result_table" style="overflow-x: scroll; width : 100%;">
                <tr>
                    <th>名前</th>
                    <th>メッセージ数</th>
                    <th>テキスト</th>
                    <th>画像数</th>
                    <th>動画</th>
                    <th>スタンプ</th>
                </tr>
            </table>
        </div>

        <div class="uk-section" id="daily-data" style="display: none;">
            <canvas id="daily-chart"></canvas>
        </div>

        <div class="uk-section" id="help">
            <h3>このサイトの使い方</h3>
            <ol>
                <li>Lineのグループから「トーク履歴の送信」を押してtxtファイルをダウンロードする</li>
                <li>このサイトにtxtファイルをアップロードする</li>
                <li>「読み込む」をクリック</li>
            </ol>
        </div>
    </div>

    <script>
        function loadFileAsText() {
            $('#File_selection').hide();
            $('#help').hide();
            $('#status').text("読み込み中");
            var fileToLoad = document.getElementById("fileToLoad").files[0];

            var fileReader = new FileReader();
            fileReader.onload = function (fileLoadedEvent) {
                var textFromFileLoaded = fileLoadedEvent.target.result;
                window.file_text = textFromFileLoaded;
                GetGata(textFromFileLoaded);
            };

            fileReader.readAsText(fileToLoad, "UTF-8");
        }
        function GetGata(text) {
            $('#status').text("ファイルを分析中");
            var lines = text.split('\n');

            var message = 0
            var text = 0
            var stamp = 0
            var image = 0
            var movie = 0
            var members = {}
            var date = {}

            var line_date = ""

            for (var line = 0; line < lines.length; line++) {
                var regex_date = new RegExp(/^\d\d\d\d[/]\d?\d[/]\d?\d[(].[)]/);
                if (regex_date.test(lines[line])) {
                    line_date = lines[line]
                }

                var regex = new RegExp(/^\d?\d:\d\d/);
                if (regex.test(lines[line])) {
                    message += 1
                    var name = lines[line].split(/\s/)[1]
                    if (members[name] == null) {
                        members[name] = {}
                        members[name]["message"] = 0
                        members[name]["contents"] = {}
                        members[name]["contents"]["text"] = 0
                        members[name]["contents"]["image"] = 0
                        members[name]["contents"]["movie"] = 0
                        members[name]["contents"]["stamp"] = 0

                    }
                    if (date[line_date] == null) {
                        date[line_date] = 0
                    }
                    date[line_date] += 1
                    members[name]["message"] += 1

                    //if (members[name]){}
                    if (lines[line].indexOf('[写真]') !== -1) {
                        image += 1
                        members[name]["contents"]["image"] += 1
                    } else if (lines[line].indexOf('[動画]') !== -1) {
                        movie += 1
                        members[name]["contents"]["movie"] += 1
                    } else if (lines[line].indexOf('[スタンプ]') !== -1) {
                        stamp += 1
                        members[name]["contents"]["stamp"] += 1
                    } else {
                        text += 1
                        members[name]["contents"]["text"] += 1
                    }
                }
            }
            $('#status').text("完了");
            $('#result, #search-box, #daily-data').show();
            $('#result_title').text(`総メッセージ数${message} | テキスト数${text} | 画像数${image} | 動画数${movie} | スタンプ数${stamp}`);
            var keys = Object.keys(members);
            for (var i = 0; i < keys.length; i++) {
                var name = keys[i]
                var member = members[keys[i]]
                $("#result_table").append(`<tr><td>${name}</td><td>${member["message"]}</td><td>${member["contents"]["text"]}</td><td>${member["contents"]["image"]}</td><td>${member["contents"]["movie"]}</td><td>${member["contents"]["stamp"]}</td></tr>`);
            }
            createDailyChart(date)
        }
        $('#search-button').on('click', function () {
            var text = window.file_text;
            var targetStr = $('#search').val();
            var count = (text.match(new RegExp(targetStr, "g")) || []).length;
            alert(`検索結果: ${count}`);
        });
    </script>
    <script>
        function createDailyChart(date) {
            var date_keys = Object.keys(date);
            var days = []
            var numbers = []
            for (var i = 0; i < date_keys.length; i++) {
                var day = date_keys[i]
                var n = date[date_keys[i]]
                days.push(day)
                numbers.push(n)
            }

            var ctx = document.getElementById("daily-chart");
            var myLineChart = new Chart(ctx, {
                // グラフの種類：折れ線グラフを指定
                type: 'line',
                data: {
                    // x軸の各メモリ
                    labels: days,
                    datasets: [
                        {
                            label: 'メッセージ数',
                            data: numbers,
                            borderColor: "#0067c0",
                            backgroundColor: "#00000000",
                            lineTension: 0
                        },
                    ],
                },
            });
        }


    </script>
</body>

</html>